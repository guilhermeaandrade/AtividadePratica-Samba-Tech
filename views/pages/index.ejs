<!DOCTYPE html>
<html>
	<head>
	  	<% include ../partition/header.ejs %>
	</head>

	<body>
		<div class="container">
      <div class="header clearfix">
        <h3 class="text-muted">AppVideoConverter</h3>
      </div>

			<div class="alert alert-success alert-dismissible fade in" role="alert" style="display:none;" id="alSuccess">
					<button type="button" class="close" data-dismiss="alert" aria-label="Close">
			    		<span aria-hidden="true">&times;</span>
			  	</button>
					<strong>Sucesso!</strong> Video foi convertido é pode ser visualizado abaixo.
			</div>
	 	  <div class="alert alert-info alert-dismissible fade in" role="alert" style="display:none;" id="alInfo">
				  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
				 		<span aria-hidden="true">&times;</span>
					</button>
					<strong>Videos</strong> processo de conversão do video foi iniciada.
	 	  </div>
			<div class="alert alert-danger alert-dismissible fade in" role="alert" style="display:none;" id="alDanger">
					<button type="button" class="close" data-dismiss="alert" aria-label="Close">
			    		<span aria-hidden="true">&times;</span>
			  	</button>
					<strong>Erro!</strong> Erro na conversão do video.
			</div>

			<div class="jumbotron">
				 <h2>Converte Videos</h2>
				 <p class="lead">Aplicação Web que possibilita a conversão de arquivos de video de um formato
					 específico, não compatível com os padrões da web, para um formato que seja compatível com os padrões da web.</p>
				 <br />
				 <form method="POST">
					  <div class="form-group">
					    <label for="file_input" class="control-label">Selecione um arquivo:</label>
					    <input type="file" id="file_input" class="file" data-show-preview="false">
					  </div>
					  <button type="submit" class="btn btn-primary" id="btnConvert">Converter Video</button>
				</form>
			</div>
			<div class="jumbotron">
				<h2>Assistir Video</h2>
				<p class="lead">Possibilita a visualização dos videos após sua conversão para um formato padrão da web.</p>
				<center>
					<video width="640" height="480" controls="controls"  id="video">
				 			<source src="https://s3-sa-east-1.amazonaws.com/apsambatech/test7.mp4" type="video/mp4">
							<object data="" width="640" height="480">
									<embed width="640" height="480" src="https://s3-sa-east-1.amazonaws.com/apsambatech/test7.mp4">
							</object>
					</video>
				</center>
		 </div>
	 </div>
	 <br />
	 <script>
	 		$("#btnConvert").click(function(){
					$('#alInfo').show();
			});

			(function() {
				console.log("intial");
	    	document.getElementById("file_input").onchange = function(){
		        var files = document.getElementById("file_input").files;
						var file = files[0];
						if(file == null){
								$('#alDanger').show();
		        }
		        else{
		            getRequestToUploadFile(file);
		        }
	    	};
			})();

			function getRequestToUploadFile(file){
					console.log("getRequestToUploadFile");
			    var xhr = new XMLHttpRequest();
			    xhr.open("GET", "/sign_s3?file_name="+file.name+"&file_type="+file.type);
					xhr.onreadystatechange = function(){
							console.log("onreadystatechange");
			        if(xhr.readyState === 4){
			            if(xhr.status === 200){
					            var response = JSON.parse(xhr.responseText);
											uploadFile(file, response.signed_request, response.url);
			            }
			            else{
											$('#alDanger').show();
			            }
			        }
			    };
			    xhr.send();
			}

			function uploadFile(file, signed_request, url){
					console.log("uploadFile");
			    var xhr = new XMLHttpRequest();
					console.log("signed_request: "+signed_request);
			    xhr.open("PUT", signed_request);
			    xhr.setRequestHeader('x-amz-acl', 'public-read');
			    xhr.onload = function() {
							console.log("xhr.onload");
			        if (xhr.status === 200) {
									$('#alSuccess').show();
									document.getElementById("video").src = url
									document.getElementById("video").value = url;
			        }
			    };
			    xhr.onerror = function() {
							$('#alDanger').show();
			    };
			    xhr.send(file);
			}
	 </script>
	</body>
</html>
